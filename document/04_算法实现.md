# 04 算法实现细节（对应代码）

本章把“论文/教材里的算法流程”对应到项目实现，帮助你读代码、改算法、做扩展。

核心文件：
- 求解器：`General Problem Solver/+gps/+logic/ventilation_network_solver_generic.m`
- 回路识别：`General Problem Solver/+gps/+logic/identify_fundamental_loops.m`

---

## 1. 输入输出与符号约定

### 输入（结构体）

- `Branches`：分支数据（`id/from_node/to_node/R`）
- `Boundary`：边界条件（`Q_total/inlet_node/outlet_node`）
- `SolverOptions`：求解器选项（`max_iter/tolerance/relaxation/verbose` 等）

### 输出

- `Q (B×1)`：分支风量，正号表示 `from_node -> to_node` 方向
- `Results`：收敛与中间量（`LoopMatrix/node_residual/pressure_diff_*` 等）

---

## 2. 回路识别：生成树（Spanning Tree）法

对应代码：`identify_fundamental_loops.m`

### 关键结论

对一个连通无向图（节点数 `N`，边数 `B`）：

$$
M = B - N + 1
$$

其中 `M` 是独立基本回路数量（Fundamental cycles）。

### 计算步骤（实现思路）

1) 用 MATLAB `graph(from,to)` 建立无向图（忽略分支方向，仅用于拓扑）
2) 用 DFS 构造生成树（N-1 条树边）
3) 找出“非树边”（chord），每条 chord + 树上的唯一路径构成一个基本回路
4) 将回路写成 `LoopMatrix (M×B)`，元素为 `-1/0/+1`

输出：
- `LoopMatrix`：每行一个回路
- `LoopInfo(k)`：回路 k 的分支列表、符号、chord 等

---

## 3. 初始可行流：最小范数解

对应代码：`ventilation_network_solver_generic.m` 中的 `feasible_initial_flow`

目标：求一个满足节点守恒的风量分布：

$$
\mathbf{A}\mathbf{Q}^{(0)}=\mathbf{b}
$$

由于 $\mathbf{A}$ 行相关（秩为 `N-1`），实现中删去一行形成约化矩阵：
- `A_red = A(2:end,:)`
- `b_red = b(2:end)`

采用最小范数特解：

$$
\mathbf{Q}^{(0)} = \mathbf{A}_{red}^\top(\mathbf{A}_{red}\mathbf{A}_{red}^\top)^{-1}\mathbf{b}_{red}
$$

实现要点：
- 计算 `M = A_red*A_red'` 并检查 `rcond(M)`，避免奇异
- 最后用完整的 `A*Q0 - b` 再验证一次节点守恒

---

## 4. Hardy Cross：回路迭代修正

对应代码：`ventilation_network_solver_generic.m`

### 4.1 回路残差（压降闭合误差）

对回路 k：

$$
F_k(\mathbf{Q}) = \sum_{j \in loop_k} s_{kj}\, R_j\, Q_j\, |Q_j|
$$

目标是让所有回路满足：

$$
F_k(\mathbf{Q}) = 0
$$

### 4.2 修正量（典型 Hardy Cross 公式）

对回路 k 的修正量 $\Delta Q_k$，使用一阶近似得到：

$$
\Delta Q_k = -\frac{\sum (s_{kj} R_j Q_j |Q_j|)}{\sum (2 R_j |Q_j|)}
$$

更新规则（项目实现为逐回路 Gauss-Seidel 风格）：

$$
\mathbf{Q} \leftarrow \mathbf{Q} + \omega \, \mathbf{s}_k \Delta Q_k
$$

其中：
- $\mathbf{s}_k$ 为 `LoopMatrix` 的第 k 行转置（`B×1`）
- $\omega = SolverOptions.relaxation` 为松弛因子（提高稳定性）

### 4.3 收敛判据

项目使用双判据（更稳）：
- `max(abs(loop_residual)) < tolerance`
- `max(abs(Q - Q_old)) < tolerance`

---

## 5. 与 UI 层的衔接

UI 层并不实现求解，只负责：
- 从 `UITable` 与 `EditField_*` 读取数据
- 转换为 `Branches/Boundary/SolverOptions`
- 调用 `gps.logic.ventilation_network_solver_generic`

对应函数：`General Problem Solver/+gps/+ui/solve_network_from_ui.m`

---

## 6. 可扩展点（你可以在这里加功能）

常见二次开发方向（基本不需要改核心求解器）：
- 增加更多边界类型（例如指定节点压差、指定某些分支风量等）
- 增加分支属性（长度/断面/局部阻力），并在导入导出时保留
- 给求解器提供“用户指定初值 Q0”（目前是自动构造最小范数初值）
- 增加批处理/参数扫描脚本（见 `document/06_App外用法.md` 的进阶用法）


# GPS 通风网络求解器 - 评估与改进建议（可追溯/更可靠版本）

更新时间：2025-12-21  
适用代码版本：当前仓库 `+gps` 目录下实现（以静态代码审查为依据）

---

## 1. 可靠性声明（本报告与“结论强度”）

本报告的结论分为两类：

- **已验证问题（Verified）**：可直接从代码逻辑推出，且有明确触发条件与影响范围。
- **改进建议（Suggestion）**：可能提升可用性/体验，但需要进一步测试或用户需求确认。

本版本不再给出缺乏数据支撑的“问题总数、评分、收益百分比、ROI”等量化结论；如需量化指标，将在“验收标准与度量方法”中给出可落地的测量方式与口径。

---

## 2. 审查范围（按优先级：`+logic` > `+ui` > `+data`）

- `+gps/+logic/identify_fundamental_loops.m`（回路识别）
- `+gps/+logic/ventilation_network_solver_generic.m`（Hardy Cross 求解）
- `+gps/+ui/*.m`（导入/导出/绘图/求解按钮）
- `+gps/+data/load_network_data.m`（CSV 读取与基础校验）

---

## 3. 执行摘要（只保留可追溯结论）

### 3.1 最优先（+logic）：并联分支与“分支编号=数组下标”的隐含假设

**已验证问题（Verified）**：当前回路识别实现对“并联分支（同一对节点之间存在多条分支）”不可靠，且在多处隐含假设 `branch_id` 可直接作为 MATLAB 向量下标使用。

直接影响：回路矩阵 `LoopMatrix` 可能缺失/重复/错配分支，从而导致求解阶段使用错误回路约束（结果不可信）。

### 3.2 次优先（+ui）：并联边可视化重叠与错误提示可读性

**改进建议（Suggestion）**：当存在并联边时，当前绘图会发生重叠（用户难以分辨）；部分错误提示偏“算法内部视角”，不利于定位数据问题。

### 3.3 低优先（+data）：校验已有基础，但缺少“可破坏 +logic 的关键约束”检查

**已验证问题（Verified）**：`load_network_data.m` 已做基础校验，但未强制保证 `Branches.id` 与 `1..B`/行索引的一致性；而 `identify_fundamental_loops.m` 目前在多处把 `branch_id` 当作行下标使用。

---

## 4. 发现清单（按 `+logic` > `+ui` > `+data`）

### 4.1 +logic（最高优先级）

#### L1（Verified）：并联分支会导致回路识别错配

**证据（代码路径）**

- `identify_fundamental_loops.m` 的 DFS 生成树使用 `G.neighbors(node)` 获取相邻节点集合；该集合不会区分同一邻接节点的多条边，从而丢失“并联边”的唯一性。
- `find_branch_id(node1,node2,Branches)` 在两节点间存在多条分支时只返回第一条匹配（`idx(1)`），因此会把不同并联分支“折叠”为同一条。

**触发条件**

- 存在两节点 `u↔v`，满足 `sum((from==u & to==v) | (from==v & to==u)) > 1`。

**影响**

- 生成树选边/弦边识别不稳定；基本回路构建时 `nodes_to_branches` 与 `determine_loop_signs` 反复选中“第一条并联边”，导致 `LoopMatrix` 与实际网络不一致。

**修复建议（可落地，不依赖不存在的函数）**

- 不要通过“邻居节点 → 查找一条边”去建树；改为“以分支（边）为一等公民”建树：
  - 为每个节点建立 incident-branches 列表（每条分支都有唯一索引/ID），DFS/BFS 时遍历“分支索引”，从而天然支持并联边。
  - 或使用 `graph` 的边索引 / `G.Edges` 表进行遍历（关键是：遍历时要携带唯一边标识，而不是仅携带相邻节点）。

#### L2（Verified）：`branch_id` 被当作数组下标使用，要求更严格的数据约束

**证据（代码路径）**

- `identify_fundamental_loops.m` 中存在 `is_tree_edge(branch_id)=...`、`u = Branches.from_node(chord_id)`、`LoopMatrix(k,b_id)=...` 等写法，隐含 `branch_id == 1..B` 且可直接索引 `from_node/to_node` 与 `LoopMatrix` 列。
- `load_network_data.m` 对 `Branches.id` 的“连续性”只给 warning，且不会重排数据行。

**影响**

- 若 `branches.csv` 的 `branch_id` 连续但行顺序不是 `1..B`，回路识别会把 “id” 与 “行” 混用，导致端点/阻力/矩阵列错配。

**修复建议（两选一，需统一全工程口径）**

- **策略 A（强约束）**：明确规定输入必须满足“`Branches.id == (1..B)` 且行顺序与 id 一致”，不满足则报错并提示用户在 CSV 中重排。
- **策略 B（内部映射）**：在 +logic 内部构造 `id_to_row` 映射，所有访问 `from_node/to_node/R` 都通过行索引，所有矩阵列都通过 `branch_id` 映射一致化（允许行顺序任意）。

#### L3（Suggestion）：回路识别效率与可重复性

**现状**

- 基本回路构建中，每条弦边都会重新构建一次 `tree_graph`（可合并为一次构建）。

**建议**

- 将 `tree_graph = build_tree_graph(...)` 提前到弦边循环外部；在 verbose 模式下输出“树边数/弦边数/与理论 `B-N+1` 是否一致”的诊断信息，便于定位异常拓扑。

---

### 4.2 +ui（次优先级）

#### U1（Suggestion）：并联分支绘图重叠，影响排查

**现状**

- `plot_network_graph.m` / `plot_network_digraph.m` 基于节点对绘边时，并联分支会重叠在同一条线段上，用户难以确认是否存在并联结构。

**建议**

- 检测到并联分支时：
  - UI 日志明确提示“检测到并联分支：回路识别/求解结果可能不可靠（取决于是否已实现 L1）”。
  - 绘图对并联边做轻微偏移（曲线/抖动）或添加边标签（branch_id），避免完全重叠。

#### U2（Suggestion）：错误提示与数据定位

**建议**

- 对常见错误（不连通、入/回风节点越界、branch_id 口径不一致、并联分支未支持）统一输出“可行动建议”，尽量包含：出错类型、建议修复动作、相关字段名/节点/分支编号。

---

### 4.3 +data（低优先级）

#### D1（Verified）：校验强度与 +logic 假设不一致

**现状**

- `load_network_data.m` 已校验 `R>0`、`Q_total>0`、节点范围等；但对 `Branches.id` 的关键约束只给 warning。

**建议（与 L2 配套）**

- 若采用“策略 A（强约束）”，在加载阶段直接 `error` 并提示修复方式。
- 若采用“策略 B（内部映射）”，仍建议在加载阶段提示用户“行顺序与 id 不一致”，但不阻断流程。

#### D2（Suggestion）：补充结构性校验

- 重复 `branch_id`、自环（`from_node==to_node`）、孤立节点、以及“从任一入风节点到任一回风节点是否可达”（不仅仅是全图连通）等。

---

## 5. 实施顺序（对应优先级：`+logic` > `+ui` > `+data`）

### 阶段 1：修复 +logic 的正确性（必须）

1. 修复并联分支的回路识别（L1）。
2. 统一/明确 `branch_id` 与数组索引关系（L2）。
3. 合并重复构建 `tree_graph` 等非本质开销（L3，可选）。

### 阶段 2：增强 +ui 的可诊断性（应做）

1. 并联分支的 UI 提示与绘图可读性（U1）。
2. 错误提示改为“面向用户的数据定位信息”（U2）。

### 阶段 3：收紧 +data 的输入约束（配套）

1. 将 `Branches.id` 约束与 +logic 对齐（D1）。
2. 增补结构性校验（D2）。

---

## 6. 验收标准与度量方法（可验证）

为避免“主观评分”，建议以可自动化验收为准：

### 6.1 功能验收（建议新增测试用例或脚本）

- **并联分支用例**：同一对节点存在 2 条以上分支，回路识别输出的 `LoopMatrix` 必须能区分这些分支（矩阵中对应列不应被折叠为同一列）。
- **branch_id 非行序用例**：`branch_id` 连续但行顺序打乱时：
  - 若采用策略 A：必须明确报错并提示重排；
  - 若采用策略 B：结果必须与“按 id 重排”一致。
- **回路一致性**：弦边数量应与理论 `B-N+1` 同数量级（允许存在异常拓扑时的诊断输出，但不能静默给出错误矩阵）。

### 6.2 体验验收（UI）

- 检测到并联分支时，UI 必须给出明确提示；绘图能明显展示“并联存在”。
- 常见数据错误的报错信息中包含：出错类型、建议修复动作、相关字段名（至少达到用户可直接修改 CSV 的程度）。

---

## 7. 备注

- 旧版文档中的“问题数量、评分、收益百分比、ROI”等内容未提供可复现的度量方法，本版本已移除，以避免误导。
- 如需恢复量化指标，请先确定：测试网络集合、基准版本、测量脚本与统计口径。

---

文档结束。
